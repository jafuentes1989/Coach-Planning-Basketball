<!--archivo de la pagina de ejercicios-->
{% extends "plantilla.html" %}

{% block content %}
    <section class="container-fluid section-wrapper">
        <nav class="navbar">
            <h1>{% block title %}Ejercicios{% endblock %}</h1>
            <a href="{{ url_for('ejercicios.crear_ejercicio') }}" class="btn btn-success">Nuevo</a>
        </nav>

        <form class="row g-2 mb-3" method="get" action="{{ url_for('perfil.ejercicios') }}">
            <div class="col-md-2">
                <input type="text" name="autor" class="form-control" placeholder="Autor" value="{{ autor_filtro or '' }}">
            </div>
            <div class="col-md-3">
                <select name="fundamento_trabajado" class="form-control">
                    <option value="" {% if not fundamento_filtro %}selected{% endif %}>Fundamento trabajado</option>
                    <option value="resistencia" {% if fundamento_filtro == 'resistencia' %}selected{% endif %}>Resistencia</option>
                    <option value="velocidad" {% if fundamento_filtro == 'velocidad' %}selected{% endif %}>Velocidad</option>
                    <option value="fuerza" {% if fundamento_filtro == 'fuerza' %}selected{% endif %}>Fuerza</option>
                    <option value="potencia" {% if fundamento_filtro == 'potencia' %}selected{% endif %}>Potencia</option>
                    <option value="agilidad" {% if fundamento_filtro == 'agilidad' %}selected{% endif %}>Agilidad</option>
                    <option value="bote" {% if fundamento_filtro == 'bote' %}selected{% endif %}>Bote</option>
                    <option value="finalizaciones" {% if fundamento_filtro == 'finalizaciones' %}selected{% endif %}>Finalizaciones</option>
                    {% if mostrar_ver %}
                    <th class="col">Ver</th>
                    {% endif %}
                    <option value="tiro" {% if fundamento_filtro == 'tiro' %}selected{% endif %}>Tiro</option>
                    <option value="pase" {% if fundamento_filtro == 'pase' %}selected{% endif %}>Pase</option>
                    <option value="transiciones" {% if fundamento_filtro == 'transiciones' %}selected{% endif %}>Transiciones</option>
                    <option value="rebote" {% if fundamento_filtro == 'rebote' %}selected{% endif %}>Rebote</option>
                    <option value="bloqueos" {% if fundamento_filtro == 'bloqueos' %}selected{% endif %}>Bloqueos</option>
                    <option value="defensa" {% if fundamento_filtro == 'defensa' %}selected{% endif %}>Defensa</option>
                    <option value="sistemas" {% if fundamento_filtro == 'sistemas' %}selected{% endif %}>Sistemas</option>
                    <option value="miniaturas" {% if fundamento_filtro == 'miniaturas' %}selected{% endif %}>Miniaturas</option>
                    <option value="partido" {% if fundamento_filtro == 'partido' %}selected{% endif %}>Partido</option>
                    <option value="continuo" {% if fundamento_filtro == 'continuo' %}selected{% endif %}>Continuo</option>
                    <option value="balance" {% if fundamento_filtro == 'balance' %}selected{% endif %}>Balance</option>
                </select>
            </div>
            <div class="col-md-3">
                <input type="text" name="descripcion" class="form-control" placeholder="Descripción" value="{{ descripcion_filtro or '' }}">
            </div>
            <div class="col-md-2">
                <input type="number" name="jugadores" class="form-control" placeholder="Jugadores" min="1" value="{{ jugadores_filtro or '' }}">
            </div>
            <div class="col-md-2">
                <input type="number" name="duracion" class="form-control" placeholder="Duración (min)" min="1" value="{{ duracion_filtro or '' }}">
            </div>
            <div class="col-md-12 mt-2">
                <button type="submit" class="btn btn-success">Filtrar</button>
                <a href="{{ url_for('perfil.ejercicios') }}" class="btn btn-secondary ms-2">Limpiar</a>
            </div>
        </form>

    <div class="table-responsive">
    <table class="table">
            <thead>
                <tr>
                    <th class="col">ID</th>
                    <th class="col">autor</th>
                    <th class="col">titulo</th>
                    <th class="col">fundamento trabajado</th>
                    <th class="col">imágenes</th>
                    <th class="col">descripcion</th>
                    <th class="col">numero jugadores</th>
                    <th class="col">duración (min)</th>
                    <th class="col">confidencial</th>
                </tr>
            </thead>
            <tbody>
                {% for ejercicio in ejercicios | reverse %}
                <tr>
                    <td>
                        <p>{{ ejercicio.id }}</p>
                    </td>
                    <td>
                        <p>{{ ejercicio.autor }}</p>
                    </td>
                    <td>
                        <p>{{ ejercicio.titulo }}</p>
                    </td>
                    <td>
                        <p>{{ ejercicio.fundamento_trabajado }}</p>
                    </td>
                    <td>
                        {% if ejercicio.imagen_url %}
                        <img src="{{ url_for('static', filename=ejercicio.imagen_url) }}" alt="Imagen 1" style="max-width: 80px; max-height: 80px; cursor: pointer;" class="me-1 clickable-image" data-fullsrc="{{ url_for('static', filename=ejercicio.imagen_url) }}">
                        {% endif %}
                        {% if ejercicio.imagen_url_2 %}
                        <img src="{{ url_for('static', filename=ejercicio.imagen_url_2) }}" alt="Imagen 2" style="max-width: 80px; max-height: 80px; cursor: pointer;" class="me-1 clickable-image" data-fullsrc="{{ url_for('static', filename=ejercicio.imagen_url_2) }}">
                        {% endif %}
                        {% if ejercicio.imagen_url_3 %}
                        <img src="{{ url_for('static', filename=ejercicio.imagen_url_3) }}" alt="Imagen 3" style="max-width: 80px; max-height: 80px; cursor: pointer;" class="clickable-image" data-fullsrc="{{ url_for('static', filename=ejercicio.imagen_url_3) }}">
                        {% endif %}
                    </td>
                    <td>
                        <p>{{ ejercicio.descripcion }}</p>
                    </td>
                    <td>
                        <p>{{ ejercicio.jugadores }}</p>
                    </td>
                    <td>
                        <p>{{ ejercicio.duracion }}</p>
                    </td>
                    <td>
                        <p>{{ 'Sí' if ejercicio.confidencial else 'No' }}</p>
                    </td>
                    {% if mostrar_ver %}
                    <td>
                        <button type="button"
                                class="btn btn-primary btn-sm btn-ver-ejercicio"
                                data-bs-toggle="modal"
                                data-bs-target="#detalleEjercicioModal"
                                data-titulo="{{ ejercicio.titulo }}"
                                data-fundamento="{{ ejercicio.fundamento_trabajado }}"
                                data-jugadores="{{ ejercicio.jugadores }}"
                                data-duracion="{{ ejercicio.duracion }}"
                                data-descripcion="{{ ejercicio.descripcion }}"
                                data-imagen1="{% if ejercicio.imagen_url %}{{ url_for('static', filename=ejercicio.imagen_url) }}{% endif %}"
                                data-imagen2="{% if ejercicio.imagen_url_2 %}{{ url_for('static', filename=ejercicio.imagen_url_2) }}{% endif %}"
                                data-imagen3="{% if ejercicio.imagen_url_3 %}{{ url_for('static', filename=ejercicio.imagen_url_3) }}{% endif %}">
                            Ver
                        </button>
                    </td>
                    {% endif %}
                    <td>
                        {% if ejercicio.autor == g.usuario.alias %}
                        <a href="{{ url_for('ejercicios.editar_ejercicio', id=ejercicio.id) }}" class="btn btn-info btn-sm">Editar</a>
                        {% endif %}
                    </td>
                    <td>
                        {% if ejercicio.autor == g.usuario.alias %}
                        <a href="{{ url_for('ejercicios.eliminar_ejercicio', id=ejercicio.id) }}" class="btn btn-danger">Eliminar</a>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        </div>

        <!-- Modal detalle ejercicio -->
        <div class="modal fade" id="detalleEjercicioModal" tabindex="-1" aria-labelledby="detalleEjercicioModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="detalleEjercicioModalLabel">Detalle ejercicio</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <h4 id="detalleTitulo"></h4>
                        <p class="mb-2" id="detalleInfoLinea"></p>
                        <div class="mb-3" id="detalleImagenes" style="display: flex; gap: 0.5rem; flex-wrap: wrap;"></div>
                        <p id="detalleDescripcion" class="mt-2"></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            document.addEventListener('click', function (event) {
                const button = event.target.closest('.btn-ver-ejercicio');
                if (!button) return;

                const titulo = button.getAttribute('data-titulo') || '';
                const fundamento = button.getAttribute('data-fundamento') || '';
                const jugadores = button.getAttribute('data-jugadores') || '';
                const duracion = button.getAttribute('data-duracion') || '';
                const descripcion = button.getAttribute('data-descripcion') || '';
                const imagen1 = button.getAttribute('data-imagen1');
                const imagen2 = button.getAttribute('data-imagen2');
                const imagen3 = button.getAttribute('data-imagen3');

                const tituloEl = document.getElementById('detalleTitulo');
                const infoLineaEl = document.getElementById('detalleInfoLinea');
                const descEl = document.getElementById('detalleDescripcion');
                const imagenesEl = document.getElementById('detalleImagenes');

                if (tituloEl) tituloEl.textContent = titulo;
                if (infoLineaEl) infoLineaEl.textContent = `Fundamento: ${fundamento} | Jugadores: ${jugadores} | Duración: ${duracion} min`;
                if (descEl) descEl.textContent = descripcion;

                if (imagenesEl) {
                    imagenesEl.innerHTML = '';
                    [imagen1, imagen2, imagen3].forEach(src => {
                        if (src) {
                            const img = document.createElement('img');
                            img.src = src;
                            img.alt = 'Imagen ejercicio';
                            img.style.maxWidth = '120px';
                            img.style.maxHeight = '120px';
                            img.style.cursor = 'pointer';
                            img.classList.add('clickable-image', 'me-1');
                            img.setAttribute('data-fullsrc', src);
                            imagenesEl.appendChild(img);
                        }
                    });
                }
            });
        </script>
    </section>
{% endblock %}