{% extends "plantilla.html" %}

{% block content %}
    <section class="container-fluid">
        <nav class="navbar mb-3">
            <h1>{% block title %}Usuarios{% endblock %}</h1>
        </nav>

        <form class="row g-2 mb-3" method="get" action="{{ url_for('perfil.seguir_usuarios') }}">
            <div class="col-md-2">
                <input type="text" name="alias" class="form-control" placeholder="Alias" value="{{ alias_filtro or '' }}">
            </div>
            <div class="col-md-2">
                <input type="text" name="nombre" class="form-control" placeholder="Nombre" value="{{ nombre_filtro or '' }}">
            </div>
            <div class="col-md-2">
                <input type="text" name="apellido" class="form-control" placeholder="Apellido" value="{{ apellido_filtro or '' }}">
            </div>
            <div class="col-md-3">
                <input type="text" name="email" class="form-control" placeholder="Email" value="{{ email_filtro or '' }}">
            </div>
            <div class="col-md-1">
                <input type="text" name="club" class="form-control" placeholder="Club" value="{{ club_filtro or '' }}">
            </div>
            <div class="col-md-1">
                <select name="nivel" class="form-control">
                    <option value="" {% if not nivel_filtro %}selected{% endif %}>Nivel</option>
                    <option value="1" {% if nivel_filtro == '1' %}selected{% endif %}>1</option>
                    <option value="2" {% if nivel_filtro == '2' %}selected{% endif %}>2</option>
                    <option value="Nacional" {% if nivel_filtro == 'Nacional' %}selected{% endif %}>Nacional</option>
                </select>
            </div>
            <div class="col-md-1">
                <input type="number" name="temporadas" class="form-control" placeholder="Temp." min="1" max="30" value="{{ temporadas_filtro or '' }}">
            </div>
            <div class="col-md-12 mt-2">
                <button type="submit" class="btn btn-success">Filtrar</button>
                <a href="{{ url_for('perfil.seguir_usuarios') }}" class="btn btn-secondary ms-2">Limpiar</a>
            </div>
        </form>

        <table class="table">
            <thead>
                <tr>
                    <th class="col">ID</th>
                    <th class="col">alias</th>
                    <th class="col">nombre</th>
                    <th class="col">apellido</th>
                    <th class="col">email</th>
                    <th class="col">nivel</th>
                    <th class="col">temporadas</th>
                    <th class="col">club actual</th>
                </tr>
            </thead>
            <tbody>
                {% for usuario in usuarios | reverse %}
                <tr>
                    <td>
                        <p>{{ usuario.id }}</p>
                    </td>
                    <td>
                        <p>{{ usuario.alias }}</p>
                    </td>
                    <td>
                        <p>{{ usuario.nombre }}</p>
                    </td>
                    <td>
                        <p>{{ usuario.apellido }}</p>
                    </td>
                    <td>
                        <p>{{ usuario.email }}</p>
                    </td>
                    <td>
                        <p>{{ usuario.nivel }}</p>
                    </td>
                    <td>
                        <p>{{ usuario.temporadas }}</p>
                    </td>
                    <td>
                        <p>{{ usuario.club }}</p>
                    </td>
                    <td>
                        {% set estado = estados_seguidos.get(usuario.alias) %}
                        {% if estado is none %}
                            {# No existe relación: se puede enviar solicitud #}
                            <form action="{{ url_for('perfil.seguir', alias=usuario.alias) }}" method="post" class="d-inline">
                                <button type="submit" class="btn btn-info btn-sm">Solicitar</button>
                            </form>
                        {% elif estado == 'pendiente' %}
                            {# Solicitud enviada pero aún no aceptada #}
                            <button type="button" class="btn btn-secondary btn-sm" disabled>Solicitado</button>
                        {% elif estado == 'aceptado' %}
                            {# Relación aceptada: permitir eliminar (dejar de seguir) #}
                            <form action="{{ url_for('perfil.dejar_de_seguir', alias=usuario.alias) }}" method="post" class="d-inline">
                                <button type="submit" class="btn btn-danger btn-sm">Eliminar</button>
                            </form>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </section>
{% endblock %}